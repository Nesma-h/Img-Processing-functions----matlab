function out = Gamma_noise(img, k, theta)
% Gamma_noise - Adds Gamma (Erlang) noise to an image
%   out = Gamma_noise(img, k, theta)
%   img   : Input image (uint8 or double, grayscale or RGB)
%   k     : Shape parameter (integer, e.g. 1 to 10)
%   theta : Scale parameter (positive, controls noise strength)
%   out   : Noisy image (uint8)

if nargin < 3
    theta = 10;  % ??????? ????
end
if nargin < 2
    k = 3;
end

k = round(k);  % ???? ???? integer

% ????? ?? double [0,1] ???? ??????? ???? ???????
img_double = im2double(img);

% ?????
[rows, cols, ch] = size(img_double);

% ????? Gamma noise
if ch == 1  % Grayscale
    noise = gamrnd(k, theta, rows, cols);  % ???? ???? (?? ????? ??????? gamrnd)
    % ?? ??????? ??????? ???? ???????:
    % noise = zeros(rows, cols);
    % for i = 1:k
    %     noise = noise - theta * log(1 - rand(rows, cols));
    % end
else  % RGB
    noise = zeros(rows, cols, ch);
    for c = 1:ch
        temp = zeros(rows, cols);
        for i = 1:k
            temp = temp - theta * log(1 - rand(rows, cols));
        end
        noise(:,:,c) = temp;
    end
end

% ???????: ??? ??????? mean-zero ???? ?????? ?????? ?????
noise = noise - mean(noise(:));

% ????? ???????
out_double = img_double + noise;

% Clipping ?????? [0,1]
out_double = max(0, min(1, out_double));

% ????? uint8
out = im2uint8(out_double);

end
