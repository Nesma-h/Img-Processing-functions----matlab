function out = rayleigh_noise(img, sigma)
% rayleigh_noise - Adds Rayleigh noise to an image
%   out = rayleigh_noise(img, sigma)
%   img   : Input image (uint8 or double, grayscale or RGB)
%   sigma : Scale parameter for Rayleigh distribution (default = 25)
%           Recommended values: 10 to 50 for visible noise
%   out   : Noisy image (same class as input)

if nargin < 2
    sigma = 25;  % ???? ???????? ????? ???? ????? ?????
end

% ????? ?????? ?? double ???????? ????????
img_double = im2double(img);

% ????? ??????
[rows, cols, channels] = size(img_double);

% ????? ????? Rayleigh
% Rayleigh pdf: f(x) = (x/sigma^2) * exp(-x^2/(2*sigma^2)), x >= 0
% ????? ???????: sigma * sqrt(-2 * log(1 - U)), U ~ Uniform(0,1)
noise = sigma * sqrt(-2 * log(1 - rand(rows, cols, channels)));

% ???????: ??? ??????? mean-zero (???? ??? additive noise)
noise = noise - mean(noise(:));

% ????? ??????? ??????
out_double = img_double + noise;

% Clipping ?????? [0,1]
out_double = max(0, min(1, out_double));

% ????? ??? ??? ?????? ???????
if isa(img, 'uint8')
    out = im2uint8(out_double);
else
    out = out_double;  % ?? ???? double ?????
end

end

